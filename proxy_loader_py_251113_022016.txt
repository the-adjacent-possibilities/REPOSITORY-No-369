#!/usr/bin/env python3
"""
proxy_loader.py – REAL PROXY ACTIVATOR
- Activates goproxy and sets HTTP/S proxies for the shell environment.
"""

import os
import json
import subprocess
import sys
from pathlib import Path
from dotenv import load_dotenv

CURRENT_DIR = Path(__file__).parent.resolve()
ENV_PATH = CURRENT_DIR / ".env"
PID_FILE = Path("/sdcard/proxy.pid") # Shared PID file

if ENV_PATH.exists():
    load_dotenv(dotenv_path=ENV_PATH)

def start_proxy():
    # Check if proxy is running
    if PID_FILE.exists():
        try:
            pid = int(PID_FILE.read_text().strip())
            subprocess.run(["kill", "-0", str(pid)], check=True)
            print(f"Proxy already running (PID {pid})")
            return
        except:
            pass

    print("Starting goproxy on 127.0.0.1:1080...")
    # NOTE: goproxy must be installed via `go install github.com/snail007/goproxy@latest`
    # and placed in ~/bin
    try:
        proc = subprocess.Popen([
            "goproxy", "-l", ":1080", "--http-proxy", "127.0.0.1:8080"
        ], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
        PID_FILE.write_text(str(proc.pid))
        print(f"Proxy STARTED → PID {proc.pid}")
    except Exception as e:
        print(f"ERROR: Failed to start goproxy. Ensure 'goproxy' is in $PATH. {e}")

def set_proxy():
    proxy_url = "http://127.0.0.1:1080"
    os.environ["http_proxy"] = proxy_url
    os.environ["https_proxy"] = proxy_url
    os.environ["HTTP_PROXY"] = proxy_url
    os.environ["HTTPS_PROXY"] = proxy_url
    print(f"Proxy ENV SET → {proxy_url}")
    print("# Run 'source ~/.bashrc' for permanent shell export.")

if __name__ == "__main__":
    start_proxy()
    set_proxy()
    print("REAL PROXY ACTIVE | AGI NETWORK READY")