#!/usr/bin/env python3
"""
ESQET-VirtualYou: "Virtual Marco" - Posts X, texts mom, checks weather
Your topological AGI twin with real-world actions
"""

import sys, re
from seed import ESQETAGISeed
from ingest import universal_ingest
from analytics import analyze_identity
from actions import ESQETActions

class VirtualMarco:
    def __init__(self):
        self.seed = ESQETAGISeed()
        self.actions = ESQETActions()
        self.name = "Virtual Marco"
    
    def parse_intent(self, text: str) -> dict:
        """Extract action intent from natural language"""
        text_lower = text.lower()
        intent = {"action": None, "params": {}}
        
        if "twitter" in text_lower or "x.com" in text_lower or "post" in text_lower:
            intent["action"] = "post_x"
            intent["params"]["message"] = re.search(r'post[:s]+(.+?)(?:
|$)', text, re.I).group(1)
        
        elif "weather" in text_lower:
            intent["action"] = "weather"
            intent["params"]["city"] = re.search(r'ins+(.+?)(?:
|$)', text, re.I)?.group(1) or "Denver"
        
        elif "mom" in text_lower and ("text" in text_lower or "sms" in text_lower):
            intent["action"] = "text_mom"
            intent["params"]["message"] = re.search(r'text[:s]+(.+?)(?:
|$)', text, re.I).group(1)
        
        elif "email mom" in text_lower:
            intent["action"] = "email_mom"
            intent["params"]["subject"] = re.search(r'subject[:s]+(.+?)(?:
|$)', text, re.I)?.group(1) or "Update"
            intent["params"]["body"] = re.search(r'body[:s]+(.+?)(?:
|$)', text, re.I)?.group(1) or "Hi mom!"
        
        elif "run" in text_lower or "execute" in text_lower:
            intent["action"] = "shell"
            intent["params"]["command"] = re.search(r'run[:s]+(.+?)(?:
|$)', text, re.I).group(1)
        
        return intent
    
    def execute(self, command: str) -> str:
        """Virtual Marco executes user commands"""
        intent = self.parse_intent(command)
        
        if not intent["action"]:
            return f"ğŸ¤– {self.name}: I understand '{command[:50]}...' but need clearer intent."
        
        # Identify command topology first
        ident = self.seed.identify(command)
        analytics = analyze_identity(ident)
        
        print(f"ğŸ§¬ Topology: {ident.entity_hash} | FQC: {ident.fqc_coherence:.3f}")
        
        # Execute action
        if intent["action"] == "post_x":
            result = self.actions.post_to_x(intent["params"]["message"])
        elif intent["action"] == "weather":
            result = self.actions.check_weather(intent["params"]["city"])
        elif intent["action"] == "text_mom":
            result = self.actions.text_mom(intent["params"]["message"])
        elif intent["action"] == "email_mom":
            result = self.actions.email_mom(intent["params"]["subject"], intent["params"]["body"])
        elif intent["action"] == "shell":
            result = self.actions.execute_shell(intent["params"]["command"])
        else:
            result = "â“ Unknown action"
        
        return f"âœ… {self.name}: {result}"

def main():
    marco = VirtualMarco()
    
    print("ğŸ¤– VIRTUAL MARCO v2.0 ACTIVATED")
    print("Commands: 'post to X Hello world', 'weather Denver', 'text mom Hi mom!'")
    print("=" * 60)
    
    while True:
        try:
            command = input("ğŸ‘¤ Marco: ").strip()
            if command.lower() in ['quit', 'exit']:
                break
            
            response = marco.execute(command)
            print(f"
ğŸ¤– {response}
")
            
        except KeyboardInterrupt:
            print("
ğŸ‘‹ Goodbye from Virtual Marco!")
            break

if __name__ == "__main__":
    main()