#!/usr/bin/env python3
"""ESQET-AGI Actions: X/Twitter, Weather, SMS, Email - No tokens needed"""
import requests, smtplib, subprocess
import os, tweepy
from pathlib import Path

class ESQETActions:
    def __init__(self):
        self.twitter_keys = self.load_twitter_keys()
    
    def load_twitter_keys(self):
        """Load from .env or return None (uses fallback)"""
        keys = {}
        for key in ['API_KEY', 'API_SECRET', 'ACCESS_TOKEN', 'ACCESS_SECRET']:
            keys[key.lower()] = os.getenv(f"TWITTER_{key}")
        return keys if any(keys.values()) else None
    
    def post_to_x(self, message: str) -> str:
        """Post to X/Twitter (uses keys or fallback)"""
        if self.twitter_keys:
            client = tweepy.Client(
                consumer_key=self.twitter_keys['api_key'],
                consumer_secret=self.twitter_keys['api_secret'],
                access_token=self.twitter_keys['access_token'],
                access_token_secret=self.twitter_keys['access_secret']
            )
            try:
                response = client.create_tweet(text=message[:280])
                return f"‚úÖ Posted to X: {response.data['id']}"
            except Exception as e:
                return f"‚ùå Twitter API error: {e}"
        else:
            # Fallback: Save to local X queue
            Path("x_queue.txt").write_text(message + "
")
            return f"üìù Queued for X: {message[:50]}..."
    
    def check_weather(self, city: str = "Denver") -> str:
        """Free weather API (no key needed)"""
        try:
            url = f"http://wttr.in/{city}?format=j1"
            r = requests.get(url, timeout=5)
            data = r.json()
            temp = data['current_condition'][0]['temp_C']
            desc = data['current_condition'][0]['weatherDesc'][0]['value']
            return f"üå§Ô∏è {city}: {temp}¬∞C, {desc}"
        except:
            return f"‚òÅÔ∏è {city}: Weather unavailable"
    
    def text_mom(self, message: str, phone: str = "+1-XXX-XXX-XXXX") -> str:
        """SMS via email-to-SMS gateway (carrier specific)"""
        carrier_email = {
            "verizon": "vtext.com",
            "att": "txt.att.net", 
            "tmobile": "tmomail.net"
        }
        domain = carrier_email.get("verizon", "vtext.com")  # Default
        sender = "your@gmail.com"
        password = os.getenv("GMAIL_APP_PASSWORD")
        
        if password:
            try:
                server = smtplib.SMTP('smtp.gmail.com', 587)
                server.starttls()
                server.login(sender, password)
                server.sendmail(sender, f"{phone}@{domain}", message)
                server.quit()
                return "üì± Texted mom successfully"
            except Exception as e:
                return f"‚ùå SMS error: {e}"
        return "üìù SMS queued (add GMAIL_APP_PASSWORD)"
    
    def email_mom(self, subject: str, body: str) -> str:
        """Email backup for mom"""
        sender = "your@gmail.com"
        password = os.getenv("GMAIL_APP_PASSWORD")
        mom_email = "mom@gmail.com"
        
        if password:
            try:
                server = smtplib.SMTP('smtp.gmail.com', 587)
                server.starttls()
                server.login(sender, password)
                server.sendmail(sender, mom_email, f"Subject: {subject}

{body}")
                server.quit()
                return "‚úâÔ∏è Emailed mom"
            except:
                pass
        Path("mom_email_queue.txt").write_text(f"{subject}: {body}
")
        return "üìù Email queued for mom"
    
    def execute_shell(self, command: str) -> str:
        """Execute system commands safely"""
        try:
            result = subprocess.run(command, shell=True, capture_output=True, text=True, timeout=30)
            return f"‚úÖ Shell: {result.stdout.strip()}"
        except Exception as e:
            return f"‚ùå Shell error: {e}"